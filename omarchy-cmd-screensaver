#!/bin/bash

# Run the Omarchy screensaver using random effects from TTE in sync across monitors.

tty=$(tty 2>/dev/null)
tty_id=$(sed 's|/dev/||; s|/|-|g' <<< "$tty")

BARRIER_DIR="/tmp/omarchy-screensaver-barrier"
EFFECT_FILE="/tmp/omarchy-screensaver-effect"
STARTUP_LOCK="$BARRIER_DIR/.startup"

mkdir -p "$BARRIER_DIR"
# Only first monitor to start clears effect/done files; others must not rm
# or they'd delete EFFECT_FILE-0 that the first already wrote
if ( set -o noclobber; echo "$$" > "$STARTUP_LOCK" ) 2>/dev/null; then
  rm -f "${EFFECT_FILE}"-*
  rm -f "$BARRIER_DIR"/done-*
fi

cycle=0
prev_effect=""

effects=(
  beams binarypath blackhole bouncyballs bubbles burn colorshift crumble
  decrypt errorcorrect expand fireworks highlight laseretch middleout
  orbittingvolley overflow pour print rain randomsequence rings scattered
  slice slide smoke spotlights spray swarm sweep synthgrid thunderstorm
  unstable vhstape waves wipe
)

screensaver_in_focus() {
  hyprctl activewindow -j | jq -e '.class == "org.omarchy.screensaver"' >/dev/null 2>&1
}

exit_screensaver() {
  hyprctl keyword cursor:invisible false &>/dev/null || true
  pkill -x tte 2>/dev/null
  pkill -f org.omarchy.screensaver 2>/dev/null
  rm -f "${EFFECT_FILE}"-*
  rm -f "$BARRIER_DIR"/done-${tty_id}-*
  rm -f "$STARTUP_LOCK"
  exit 0
}

# Exit the screensaver on signals and input from keyboard and mouse
trap exit_screensaver SIGINT SIGTERM SIGHUP SIGQUIT

printf '\033]11;rgb:00/00/00\007'  # Set background color to black

hyprctl keyword cursor:invisible true &>/dev/null

monitor_count=$(hyprctl monitors -j 2>/dev/null | jq -r 'length' 2>/dev/null)
[[ -z "$monitor_count" || "$monitor_count" -lt 1 ]] && monitor_count=1

while true; do
  # First monitor to write wins; second reads the agreed effect
  if [[ -n "$prev_effect" ]]; then
    filtered=()
    for e in "${effects[@]}"; do [[ "$e" != "$prev_effect" ]] && filtered+=("$e"); done
    candidate="${filtered[$RANDOM % ${#filtered[@]}]}"
  else
    candidate="${effects[$RANDOM % ${#effects[@]}]}"
  fi
  if ( set -o noclobber; echo "$candidate" > "${EFFECT_FILE}-${cycle}" ) 2>/dev/null; then
    effect="$candidate"
  else
    while [[ ! -f "${EFFECT_FILE}-${cycle}" ]]; do sleep 0.01; done
    effect=$(cat "${EFFECT_FILE}-${cycle}")
  fi
  prev_effect="$effect"

  tte -i ~/.config/omarchy/branding/screensaver.txt \
    --frame-rate 120 --canvas-width 0 --canvas-height 0 --reuse-canvas --anchor-canvas c --anchor-text c \
    --no-eol --no-restore-cursor \
    "$effect" &

  # Wait for tte to finish
  while pgrep -t "${tty#/dev/}" -x tte >/dev/null; do
    if read -n1 -t 1 || ! screensaver_in_focus; then
      exit_screensaver
    fi
  done

  # Signal this monitor is done and wait for all monitors before starting next effect
  touch "$BARRIER_DIR/done-${tty_id}-${cycle}"
  while [[ $(ls "$BARRIER_DIR"/done-*-"${cycle}" 2>/dev/null | wc -l) -lt "$monitor_count" ]]; do
    sleep 0.01
  done
  cycle=$(( cycle + 1 ))

done
